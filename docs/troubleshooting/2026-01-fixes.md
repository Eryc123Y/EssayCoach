# EssayCoach Bug Fixes - January 2026

This document logs critical issues resolved and their solutions for future reference.

---

## Issue #1: Frontend Compilation Hang

**Date**: January 18, 2026
**Category**: Frontend / Build System
**Severity**: Critical (Development blocker)

### Symptoms

- Terminal hangs indefinitely at "Compiling /..."
- No error messages displayed
- Process cannot be interrupted gracefully
- `next dev` command appears frozen

### Root Cause

Duplicate `node_modules` directory structure detected.

**Investigation**:
```bash
ls -la frontend/ | grep node_modules
# Output showed:
# drwxr-xr-x 76 eric staff   2432 Jan 18 14:47 node_modules
```

During previous dependency management, a secondary `node_modules` directory (possibly `node_modules2`) was created, causing pnpm to hang trying to resolve the conflict.

### Solution

```bash
# From frontend directory
cd frontend

# Remove all node_modules directories
rm -rf node_modules node_modules2

# Reinstall dependencies
pnpm install

# Restart development server
pnpm dev
```

### Prevention

**Rule Added to AGENTS.md**:
> When `next dev` hangs on 'Compiling /', check for duplicate `node_modules` directories immediately.

**Verification Command**:
```bash
# Before starting dev server
ls -la | grep node_modules
```

### Related Documentation

- [Frontend README.md](../frontend/README.md#troubleshooting)

---

## Issue #2: 500 Internal Server Error - PostgreSQL Connection

**Date**: January 18, 2026
**Category**: Backend / Database
**Severity**: High (Data access failure)

### Symptoms

- Django returns `500 Internal Server Error`
- Backend logs show: `FATAL:  password authentication failed for user "essayadmin"`
- Database connection refused
- `pg-connect` command fails

### Root Cause

Environment variable mismatch between database setup and Django settings.

**Investigation**:
- `.env` file defined `POSTGRES_USER=essayadmin`
- PostgreSQL setup script created user named `postgres` in `scripts/dev-env/postgres-setup.sh`
- Django settings attempted to connect as `essayadmin`, which doesn't exist

### Solution

**Option 1: Update Environment Variable** (Preferred)
```bash
# Update root .env
echo "POSTGRES_USER=postgres" >> .env
```

**Option 2: Update Database Setup** (Not recommended for existing installs)
```bash
# Modify scripts/dev-env/postgres-setup.sh
# Change: createdb -U postgres
# To: createdb -U essayadmin
# Then recreate database
```

### Implementation

Modified `scripts/dev-env/postgres-setup.sh`:
```bash
# Line 69-78
# Changed POSTGRES_USER usage to 'postgres' consistently
```

### Prevention

**Rule**: Always verify PostgreSQL user credentials match between:
1. `.env` environment variables
2. `scripts/dev-env/postgres-setup.sh` setup
3. Django database settings configuration

### Related Documentation

- [AGENTS.md - Development Environment](../) (Line 78)
- [System Architecture - Database](../docs/architecture/system-architecture.md) (If exists)

---

## Issue #3: "Failed to fetch" - API Route Proxy Conflict

**Date**: January 18, 2026
**Category**: Frontend / Authentication
**Severity**: Critical (Authentication failure)

### Symptoms

- Frontend requests to `/api/v1/*` endpoints fail
- Browser console shows: "Failed to fetch"
- Network tab shows CORS errors or 401 Unauthorized
- Authentication cookies present but not forwarded to backend

### Root Cause

Conflict between Next.js `rewrites` configuration and custom API Route proxy logic.

**Investigation**:
1. `next.config.ts` contained `rewrites` rule:
   ```typescript
   rewrites: [{ source: '/api/v1/:path*', destination: '/api/v1/:path*' }]
   ```
2. Custom API Route handler at `src/app/api/v1/[...path]/route.ts` needed to inject Authorization headers

**Problem**: `rewrites` take precedence and bypass API Route handlers, preventing custom header injection.

### Solution

**Removed `rewrites` from `next.config.ts`**:

**Before**:
```typescript
const nextConfig = {
  output: 'export',
  rewrites: [{ source: '/api/v1/:path*', destination: '/api/v1/:path*' }]
}
```

**After**:
```typescript
const nextConfig = {
  output: 'export'
  // No rewrites - API Route handlers handle proxying
}
```

**API Route Handler** (`src/app/api/v1/[...path]/route.ts`):
```typescript
import { NextRequest, NextResponse } from 'next/server';
import { headers as nextHeaders } from 'next/headers';

export async function GET(req: NextRequest, res: NextResponse) {
  // Extract token from cookie
  const token = req.cookies.get('access_token');
  
  // Forward to Django with Authorization header
  const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}${path}`, {
    headers: {
      'Authorization': `Token ${token}`,
      ...nextHeaders(req) // Forward other headers
    }
  });
  
  return response;
}
```

### Prevention

**Rule Added to AGENTS.md**:
> Do not use Next.js `rewrites` for API proxying if custom header injection (like Auth tokens) is required; use API Route Handlers instead.

### Related Documentation

- [Authentication Architecture](../docs/architecture/authentication.md)
- [Frontend README.md](../frontend/README.md#api-integration)

---

## Issue #4: Backend API Key Not Received

**Date**: January 18, 2026
**Category**: Backend / Configuration
**Severity**: High (AI feature failure)

### Symptoms

- Dify workflow API calls fail
- Backend logs show: "DIFY_API_KEY not found"
- AI feedback feature returns errors

### Root Cause

Environment variable naming inconsistency.

**Investigation**:
- Backend code expected: `DIFY_API_KEY`
- `.env` file contained: `DIFY_API=` (incorrect naming)

### Solution

**Updated `.env` file**:
```bash
# Before
DIFY_API=sk-proj-...

# After
DIFY_API_KEY=sk-proj-...
```

**Backend `scripts/dev-env/start-backend.sh`** now correctly loads:
```bash
export DIFY_API_KEY=$(grep DIFY_API_KEY .env | cut -d '=' -f2)
```

### Prevention

**Rule**: Environment variable names must exactly match the code's expected constants.

### Related Documentation

- [AGENTS.md - Development Environment](../) (Line 78)
- [AI Feedback Feature README](../backend/ai_feedback/README.md)

---

## Issue #5: "Failed to fetch" (Configuration Conflict)

**Date**: January 18, 2026
**Category**: Frontend / Authentication
**Severity**: Critical (API connectivity failure)

### Symptoms

- API calls fail immediately with `TypeError: Failed to fetch`
- Browser console shows network errors before request completes
- Authentication requests fail silently

### Root Cause

Sentry `tunnelRoute` in `next.config.ts` conflicting with Next.js API Routes.

**Investigation**:
- `next.config.ts` contained Sentry tunnelRoute configuration
- Custom API Route handlers at `/api/v1/[...path]/route.ts` needed to handle requests
- Conflict caused requests to fail before reaching API Route handlers

### Solution

**Option 1: Disable Sentry tunnelRoute** (Recommended for development):
```typescript
// next.config.ts
const nextConfig = {
  output: 'export',
  // Comment out or remove Sentry tunnelRoute
  // tunnelRoute: '/api/v1/:path*'
}
```

**Option 2: Ensure No Path Overlap**:
- Verify `tunnelRoute` pattern doesn't conflict with API Route paths
- Use distinct patterns for internal vs. external routing

### Prevention

**Rule**: Sentry tunneling and custom API Routes must use non-overlapping path patterns.

### Related Documentation

- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [Sentry Next.js Configuration](https://docs.sentry.io/platforms/javascript/guides/nextjs/)

---

## Issue #6: "net::ERR_TOO_MANY_REDIRECTS" (Proxy Loop)

**Date**: January 18, 2026
**Category**: Frontend / Network
**Severity**: Critical (Infinite request loop)

### Symptoms

- Browser console shows infinite redirect loop on API calls
- Requests to `/api/v1/*` endpoints fail with "Too Many Redirects"
- Network tab shows repeated 301/307 status codes
- Development browser may freeze or crash

### Root Cause

API Proxy using `redirect: 'manual'` passes backend redirects (301/307) to browser. Browser requests the Proxy URL again, causing a loop.

**Investigation**:
- API Route handler at `src/app/api/v1/[...path]/route.ts` used `fetch` with default options
- Django backend returned 301/307 redirect responses
- `fetch` default behavior with `redirect: 'manual'` exposed redirects to browser
- Browser followed redirect back to same URL, creating infinite loop

### Solution

**Update API Route Handler** to follow redirects server-side:
```typescript
// src/app/api/v1/[...path]/route.ts
export async function GET(req: NextRequest, res: NextResponse) {
  const token = req.cookies.get('access_token');
  
  const response = await fetch(`${process.env.NEXT_PUBLIC_API_URL}${path}`, {
    headers: {
      'Authorization': `Token ${token}`,
      ...nextHeaders(req)
    },
    redirect: 'follow' // Critical: Handle redirects server-side
  });
  
  return response;
}
```

**Also apply to other HTTP methods** (POST, PUT, PATCH, DELETE):
```typescript
export async function POST(req: NextRequest, res: NextResponse) {
  // ... same pattern with redirect: 'follow'
}
```

### Prevention

**Rule**: Always use `redirect: 'follow'` in API Route `fetch` calls to prevent redirect loops.

### Related Documentation

- [Fetch API - redirect option](https://developer.mozilla.org/en-US/docs/Web/API/Request/redirect)
- [HTTP Status Codes - Redirects](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#redirection_messages)

---

## Issue #7: "ECONNREFUSED" (IPv6/IPv4 Resolution)

**Date**: January 18, 2026
**Category**: Frontend / Network
**Severity**: Medium (Development environment only)

### Symptoms

- Connection refused on `localhost`
- Frontend cannot connect to backend or database
- Works with `127.0.0.1` but not `localhost`

### Root Cause

Node.js v24+ defaults to IPv6 resolution for `localhost`, but services may only bind to IPv4.

**Investigation**:
- Node.js upgraded from v22 to v24.12.0 (detected in environment diagnosis)
- Django PostgreSQL server binds to IPv4 (`127.0.0.1`)
- Frontend attempts IPv6 resolution (`::1`), which fails

### Solution

**Force IPv4 binding in `package.json`**:
```json
{
  "scripts": {
    "dev": "next dev -H 127.0.0.1"
  }
}
```

**Alternative: Use IPv4 in environment variables**:
```bash
# frontend/.env.local
NEXT_PUBLIC_API_URL=http://127.0.0.1:8000
```

### Prevention

**Rule**: Use explicit IPv4 addresses (`127.0.0.1`) instead of `localhost` in development to avoid IPv6/IPv4 resolution issues.

### Related Documentation

- [Node.js IPv6 Support](https://nodejs.org/api/net.html#ipversion)
- [Localhost Resolution Issues](https://stackoverflow.com/questions/37465202/nodejs-server-listening-on-ipv6)

---

---

## Issue #8: Rubric Import Fails - Constraint Violation

**Date**: January 21, 2026
**Category**: Backend / Database
**Severity**: High (Rubric upload blocked)

### Symptoms

- Rubric PDF upload fails during database insert
- Error message: `new row for relation "rubric_level_desc" violates check constraint "min_max_ck"`
- AI parser successfully extracts rubric data but database insertion fails
- Issue occurs specifically for "No submission" levels with 0-0 score range

### Root Cause

Database constraint `RubricLevelDesc.min_max_ck` used strict inequality (`<`) preventing `score_min == score_max`.

**Investigation**:
- AI parser extracted rubric with "No submission" level having `score_min=0` and `score_max=0`
- Original constraint: `level_min_score < level_max_score`
- This blocked legitimate educational rubrics with "No submission" levels
- Standard practice in IB, AP, university rubrics to have 0-0 for absent work

**Database Check Constraint**:
```sql
-- Old constraint (invalid)
CHECK (level_min_score >= 0 AND level_max_score > 0 AND level_min_score < level_max_score)

-- Prevents 0-0 ranges used for "No submission"
```

### Solution

**Three-part fix implemented**:

**1. Python Validation Logic** (`backend/core/rubric_manager.py`, lines 208-218):
```python
# Changed from strict rejection to conditional validation
if level["score_min"] == level["score_max"]:
    level_name = level.get("name", "").lower()
    level_desc = level.get("description", "").lower()
    if (level_name != "0" and "no submission" not in level_desc
            and "absent" not in level_desc):
        raise RubricImportError(
            f"Equal score range (0-0) only allowed for 'No submission' levels. "
            f"Found: '{level_name}' - '{level_desc}'"
        )
# Still rejects invalid ranges where score_min > score_max
elif level["score_min"] > level["score_max"]:
    raise RubricImportError(
        f"Invalid score range: min ({level['score_min']}) "
        f"cannot be greater than max ({level['score_max']})"
    )
```

**2. Django Model Constraint** (`backend/core/models.py`, line 121):
```python
# Changed CheckConstraint from __lt to __lte
class RubricLevelDesc(models.Model):
    class Meta:
        constraints = [
            CheckConstraint(
                check=Q(level_min_score__gte=0)
                & Q(level_max_score__gte=0)
                & Q(level_min_score__lte=models.F("level_max_score")),  # Changed from __lt
                name="min_max_ck",
            )
        ]
```

**3. Database Constraint Update** (Applied directly via psql):
```sql
-- Updated constraint to allow equality
ALTER TABLE rubric_level_desc
DROP CONSTRAINT IF EXISTS min_max_ck;

ALTER TABLE rubric_level_desc
ADD CONSTRAINT min_max_ck
CHECK (level_min_score >= 0 AND level_max_score >= 0 AND level_min_score <= level_max_score);
```

### Verification

After applying the fix:

```bash
# Test rubric import with 0-0 range
python manage.py test core.tests.test_rubric_import

# Verify database constraint
psql -h localhost -U postgres -d essaycoach -c "\d+ rubric_level_desc"

# Should see updated constraint:
# "min_max_ck" CHECK (level_min_score >= 0 AND level_max_score >= 0 AND level_min_score <= level_max_score)
```

### Prevention

**Rule**: Always test rubric import with edge cases:
- Rubrics containing "No submission" or "0" levels with 0-0 ranges
- Rubrics with valid score ranges (0-30, 31-60, etc.)
- Ensure validation allows equality for legitimate "No submission" cases
- Prevent invalid ranges where min > max

**Documentation Reference**:
- [backend/core/README.md - Rubric Score Ranges](../backend/core/README.md#special-handling-rubric-score-ranges)
- [docs/database/schema-overview.md - Check Constraints](../database/schema-overview.md#check-constraints)

### Related Documentation

- [Rubric Import Workflow](../backend/core/rubric_manager.py)
- [Educational Assessment Standards](https://www.ibo.org/)
- [Turnitin Rubric Guidelines](https://www.turnitin.com/)

---

## Summary of Fixes Applied

 | Issue | Component | Root Cause | Status |
 |-------|-----------|-------------|--------|
 | #1 | Frontend | Duplicate node_modules | ✅ Resolved |
 | #2 | Backend/DB | POSTGRES_USER mismatch | ✅ Resolved |
 | #3 | Frontend/Auth | rewrites vs API Route conflict | ✅ Resolved |
 | #4 | Backend/Config | DIFY_API vs DIFY_API_KEY | ✅ Resolved |
 | #5 | Frontend/Auth | Sentry tunnelRoute conflict | ✅ Documented |
 | #6 | Frontend/Network | Proxy redirect loop | ✅ Documented |
 | #7 | Frontend/Network | IPv6/IPv4 resolution | ✅ Documented |
 | #8 | Backend/DB | Rubric constraint violation | ✅ Resolved |

## Post-Fix Verification Checklist

After applying these fixes, verify the following:

- [ ] Frontend dev server starts without hanging
- [ ] No duplicate node_modules directories exist
- [ ] `pg-connect` command succeeds
- [ ] Django backend starts without database errors
- [ ] Login flow sets `access_token` cookie
- [ ] `/api/v1/auth/me/` returns authenticated user data
- [ ] AI feedback workflow executes successfully
- [ ] DIFY_API_KEY is properly loaded in backend
- [ ] API calls succeed without "Failed to fetch" errors
- [ ] No "Too Many Redirects" errors in browser console
- [ ] Frontend connects to backend using IPv4 address
- [ ] Sentry tunneling doesn't conflict with API Routes
- [ ] Rubric import with "No submission" levels (0-0) succeeds
- [ ] Rubric import rejects invalid score ranges where min > max
- [ ] Database constraint `min_max_ck` allows equality (<=) for rubric levels

---

## Additional Resources

- [Django REST Framework Authentication](https://www.django-rest-framework.org/api-guide/authentication/)
- [Next.js API Routes](https://nextjs.org/docs/app/building-your-application/routing/route-handlers)
- [PostgreSQL Connection Strings](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING)
- [pnpm Troubleshooting](https://pnpm.io/troubleshooting/)
